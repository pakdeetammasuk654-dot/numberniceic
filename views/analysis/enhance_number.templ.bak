package analysis

import (
	"fmt"
	"strings"
)

templ EnhanceNumber(props EnhanceNumberProps) {
	@Layout(props.Layout) {
		<div class="analysis-container" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
			<!-- Category Breakdown Section Only -->
			if len(props.SolarSystem.CategoryBreakdown) > 0 {
				<div class="category-breakdown-container">
					<div class="nested-donut-layout" style="display: flex; flex-direction: row; gap: 1.5rem; align-items: flex-start; justify-content: center; flex-wrap: wrap; padding: 0 24px;">
						<div class="nested-donut-wrapper" style="position: relative; width: 320px; height: 320px;">
							@renderDonutChart(props)
						</div>
						<div class="nested-legend" style="min-width: 450px; flex: 1; margin: 0 -24px;">
							@renderCategoryTable(props)
						</div>
					</div>
				</div>
			}
		</div>
	}
}

templ renderDonutChart(props EnhanceNumberProps) {
	<svg class="nested-donut-chart" viewBox="0 0 200 200" 
		id={ "nested-donut-" + props.CleanedName } 
		data-total-pairs={ fmt.Sprintf("%d", len(props.SolarSystem.NumerologyPairs) + len(props.SolarSystem.ShadowPairs)) }
		data-breakdown={ props.SolarSystem.GetCategoryBreakdownJSON() }
		data-active-cats={ props.SolarSystem.GetActiveCategoriesJSON() }
		style="width: 100%; height: 100%; position: relative; z-index: 1;">
		
		<defs>
			<filter id="premiumShadow">
				<feGaussianBlur in="SourceAlpha" stdDeviation="4"/>
				<feOffset dx="0" dy="4" result="offsetblur"/>
				<feComponentTransfer><feFuncA type="linear" slope="0.2"/></feComponentTransfer>
				<feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge>
			</filter>
			<linearGradient id="grad-work" gradientTransform="rotate(0)">
				<stop offset="0%" stop-color="#90CAF9"/>
				<stop offset="100%" stop-color="#42A5F5"/>
			</linearGradient>
			<linearGradient id="grad-finance" gradientTransform="rotate(-45)">
				<stop offset="0%" stop-color="#FFCC80"/>
				<stop offset="100%" stop-color="#FFA726"/>
			</linearGradient>
			<linearGradient id="grad-love" gradientTransform="rotate(45)">
				<stop offset="0%" stop-color="#F48FB1"/>
				<stop offset="100%" stop-color="#EC407A"/>
			</linearGradient>
			<linearGradient id="grad-health" gradientTransform="rotate(90)">
				<stop offset="0%" stop-color="#80CBC4"/>
				<stop offset="100%" stop-color="#26A69A"/>
			</linearGradient>
			<linearGradient id="grad-gold" x1="0%" y1="0%" x2="100%" y2="100%">
				<stop offset="0%" stop-color="#D97706"/>
				<stop offset="50%" stop-color="#FFD700"/>
				<stop offset="100%" stop-color="#B45309"/>
			</linearGradient>
		</defs>

		<g class="inner-ring" style="transform-origin: center;">
			if len(props.SolarSystem.GetChartSegments()) > 0 {
				for _, seg := range props.SolarSystem.GetChartSegments() {
					<path d={ seg.Path } fill={ seg.Fill }></path>
					if seg.Percent >= 6 && seg.Category != "N/A" {
						<text x={ fmt.Sprintf("%.2f", seg.TextX) } y={ fmt.Sprintf("%.2f", seg.TextY) } 
							text-anchor="middle" dominant-baseline="middle" 
							font-size="10px" font-weight="bold" 
							fill={ func() string { if seg.Category == "N/A" { return "#94A3B8" }; return "#FFFFFF" }() }
							style="pointer-events: none; text-shadow: 0px 1px 2px rgba(0,0,0,0.3);">
							{ fmt.Sprintf("%d%%", seg.Percent) }
						</text>
					}
				}
			}
		</g>
		<g class="outer-ring"></g>
		
		<g class="center-text-group" style="transform-origin: center;">
			<circle cx="100" cy="100" r="58" fill="white" filter="url(#premiumShadow)"></circle>
			<text x="100" y="108" text-anchor="middle" font-size="38px" font-weight="300" fill="url(#grad-gold)" font-family="Kanit, sans-serif" class="donut-center-number">
				{ fmt.Sprintf("%.0f%%", props.SolarSystem.GetBaseCategoryPercentage()) }
			</text>
		</g>
	</svg>

	<script>
		(function() {
			var id = "nested-donut-" + { props.CleanedName };
			var data = { props.SolarSystem.GetCategoryBreakdownJSON() };
			var active = { props.SolarSystem.GetActiveCategoriesJSON() };
			
			function run() {
				if (window.initNestedDonut) {
					window.initNestedDonut(id, data, active);
				} else {
					setTimeout(run, 50);
				}
			}
			run();
		})();
	</script>
}

templ renderCategoryTable(props EnhanceNumberProps) {
	<div class="breakdown-summary" style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 8px;">
		<!-- Header Row -->
		<div style="display: flex; padding: 0 16px; margin-bottom: 4px; color: #64748B; font-weight: 700; font-size: 0.9rem;">
			<div style="flex: 4;">หมวดหมู่</div>
			<div style="flex: 1.5; text-align: right;">%ดี</div>
			<div style="flex: 1.5; text-align: right;">%ร้าย</div>
			<div style="flex: 2.2; text-align: center; display: flex; align-items: center; justify-content: center; gap: 2px; white-space: nowrap;">
				<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#FFD700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
				เสริมเบอร์
			</div>
		</div>

		for _, cat := range []string{"สุขภาพ", "การงาน", "การเงิน", "ความรัก"} {
			{{
				breakdown := props.SolarSystem.CategoryBreakdown[cat]
			}}
			<div class="breakdown-item" style="padding: 12px 16px; border-bottom: 1px solid #F1F5F9; display: flex; flex-direction: column;">
				<div style="display: flex; align-items: center;">
					<div style="flex: 4; display: flex; align-items: center; gap: 8px; min-width: 0;">
						<div style={ "width: 36px; height: 36px; min-width: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; background-color: " + getCategoryColor(cat) + "20;" }>
							<span style={ "display: block; width: 12px; height: 12px; border-radius: 3px; background-color: " + getCategoryColor(cat) + ";" }></span>
						</div>
						<span style="font-weight: 700; color: #1E293B; font-size: 1.05rem; white-space: nowrap;">{ cat }</span>
					</div>

					<div style="flex: 1.5; text-align: right;" id={ fmt.Sprintf("good-score-container-%s-%s", props.CleanedName, cat) }>
						if breakdown.Good > 0 {
							<span style={ fmt.Sprintf("color: %s; font-weight: 700;", getCategoryColor(cat)) }>25%</span>
						} else {
							<span style="color: #CBD5E1; font-weight: 700;">-</span>
						}
					</div>

					<div style="flex: 1.5; text-align: right;">
						if breakdown.Bad > 0 {
							<span style="color: #EF4444; font-weight: 700;">
								if len(props.SolarSystem.NumerologyPairs) + len(props.SolarSystem.ShadowPairs) > 0 {
									{ fmt.Sprintf("%.0f%%", (float64(breakdown.Bad) / float64(len(props.SolarSystem.NumerologyPairs) + len(props.SolarSystem.ShadowPairs))) * 100) }
								} else {
									0%
								}
							</span>
						} else {
							<span style="color: #CBD5E1;">-</span>
						}
					</div>

					<div style="flex: 1.5; display: flex; justify-content: flex-end;">
						<button 
							class="btn-icon-lucky" 
							style="display: flex; align-items: center; justify-content: center; width: 38px; height: 38px; border-radius: 50%; border: none; background: linear-gradient(135deg, #FFD700, #FDB931); color: white; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 10px rgba(255, 215, 0, 0.4); position: relative; z-index: 5;"
							onmouseover="this.style.transform='scale(1.1) rotate(15deg)'"
							onmouseout="this.style.transform='scale(1) rotate(0deg)'"
							onclick={ templ.JSFuncCall("window.handleLuckyClick", cat, fmt.Sprintf("lucky-container-%s-%s", props.CleanedName, cat), "nested-donut-" + props.CleanedName) }
						>
							<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
						</button>
					</div>
				</div>
				
				<div style="width: 100%; margin-top: 8px; padding-left: 46px;">
					if len(breakdown.Keywords) > 0 {
						<div style="font-size: 0.95rem; color: #475569; margin-bottom: 8px; line-height: 1.5; font-weight: 500;">
							{ strings.Join(breakdown.Keywords, ", ") }
						</div>
					}
				</div>
				<div id={ fmt.Sprintf("lucky-container-%s-%s", props.CleanedName, cat) } style="margin-top: 12px; margin-left: -16px; margin-right: -16px; width: auto; position: relative; z-index: 10;"></div>
			</div>
		}

		<!-- Total Score Row -->
		<div class="premium-card-row" style="display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #F8FAFC, #F1F5F9); padding: 16px; border-radius: 16px; border: 1px solid #E2E8F0; margin-top: 8px;">
			<div style="display: flex; align-items: center; gap: 8px;">
				<div style="width: 40px; height: 40px; background: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#F59E0B" stroke="none"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
				</div>
				<span style="font-weight: 800; color: #1E293B; font-size: 1.1rem;">คะแนนรวม % ดี</span>
			</div>
			
			<div id={ fmt.Sprintf("total-score-%s", props.CleanedName) } data-base-score={ fmt.Sprintf("%.0f", props.SolarSystem.GetBaseCategoryPercentage()) }>
				<span class="score-value" style="font-weight: 900; font-size: 2rem; background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 2px 2px rgba(245, 158, 11, 0.15));">
					{ fmt.Sprintf("%.0f%%", props.SolarSystem.GetBaseCategoryPercentage()) }
				</span>
			</div>
		</div>
		
		<div style="margin-top: 12px; padding: 12px 16px; background: #FFFBEB; border-radius: 16px; border: 1px dashed #FCD34D; font-size: 0.85rem; color: #B45309; text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px; line-height: 1.4;">
			<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink: 0;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
			<span>คลิกปุ่ม <span style="display: inline-flex; width: 24px; height: 24px; background: linear-gradient(135deg, #FFD700, #F59E0B); border-radius: 50%; align-items: center; justify-content: center; vertical-align: middle; margin: 0 4px; box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg></span> เพื่อค้นหาเบอร์มงคลเสริมดวง</span>
		</div>
	</div>
}
