{{define "partials/solar_system"}}
<style>
    /* Ensure the solar system container is visible and handled correctly */
    .solar-system-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0;
        min-height: 290px;
        /* Kept comfortable */
        position: relative;
        z-index: 10;
        /* Planets fly over card */
        background-color: transparent !important;
        overflow: visible;
        box-shadow: none !important;
    }

    .sun {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .char-container {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* Ensure orbits are visible */
    .orbit {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border-radius: 50%;
        border-style: dashed;
        border-width: 1px;
        pointer-events: none;
    }

    .orbit-inner {
        width: 180px;
        height: 180px;
        border-color: #FF9800;
        z-index: 0;
    }

    .orbit-outer {
        width: 280px;
        height: 280px;
        border-color: #FF9800;
        z-index: 0;
    }
</style>

<!-- Solar System Animation Container -->
<div class="solar-system-container fade-slide-in">
    <div class="solar-system">
        <div class="{{if .is_sun_dead}}sun sun-dead{{else}}sun{{end}}">
            <div class="sun-name">
                <div class="char-container">
                    {{- if .SunDisplayNameHTML -}}
                    {{- range .SunDisplayNameHTML -}}
                    {{- if .IsBad -}}<span class="klakini-char">{{.Char}}</span>{{- else -}}<span>{{.Char}}</span>{{-
                    end -}}
                    {{- end -}}
                    {{- else -}}
                    <span>?</span>
                    {{- end -}}
                </div>
            </div>
        </div>

        <!-- Orbits -->
        <div class="orbit orbit-inner"></div>
        <div class="orbit orbit-outer"></div>

        <!-- Planets (Numerology) -->
        {{if .numerology_pairs}}
        {{ $numCount := len .numerology_pairs }}
        {{ range $i, $pair := .numerology_pairs }}
        {{ $divisor := div 20.0 $numCount }}
        {{ $delay := mul $i $divisor }}
        <div class="planet-container orbit-inner" style="animation-delay: -{{ $delay }}s;">
            <div class="planet"
                style="background-color: {{if .Meaning}}{{ .Meaning.Color }}{{else}}#999{{end}}; animation-delay: -{{ $delay }}s;"
                title="{{if .Meaning}}{{ .Meaning.MiracleDesc }}{{else}}Unknown{{end}}">
                {{.PairNumber}}
            </div>
        </div>
        {{ end }}
        {{end}}

        <!-- Planets (Shadow) -->
        {{if .shadow_pairs}}
        {{ $shaCount := len .shadow_pairs }}
        {{ range $i, $pair := .shadow_pairs }}
        {{ $divisor := div 30.0 $shaCount }}
        {{ $delay := mul $i $divisor }}
        <div class="planet-container orbit-outer" style="animation-delay: -{{ $delay }}s;">
            <div class="planet"
                style="background-color: {{if .Meaning}}{{ .Meaning.Color }}{{else}}#999{{end}}; animation-delay: -{{ $delay }}s;"
                title="{{if .Meaning}}{{ .Meaning.MiracleDesc }}{{else}}Unknown{{end}}">
                {{.PairNumber}}
            </div>
        </div>
        {{ end }}
        {{end}}
    </div>
</div>

<!-- Safe Score Calculation -->
{{ $posSum := add .num_positive_score .sha_positive_score }}
{{ $negSum := add .num_negative_score .sha_negative_score }}

<!-- Compact Result & Action Card -->
<div class="result-box fade-slide-in"
    style="padding: 1rem; margin-top: 0.5rem; position: relative; z-index: 5; background: rgba(255,255,255,0.95); border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">

    <!-- Revised Row: Breakdown (Left) & Total Score (Right) -->
    <div style="display: flex; justify-content: center; align-items: center; gap: 1.5rem; margin-bottom: 0.8rem;">

        <!-- Left: Breakdown Pills (Column) -->
        <div style="display: flex; flex-direction: column; gap: 0.4rem; align-items: flex-end;">
            <div
                style="font-size: 0.8rem; padding: 0.2rem 0.6rem; background: rgba(32, 191, 107, 0.1); color: #20bf6b; border-radius: 12px; font-weight: 500; min-width: 70px; text-align: center;">
                ดี {{if gt $posSum 0.0}}+{{end}}{{ $posSum }}
            </div>
            <div
                style="font-size: 0.8rem; padding: 0.2rem 0.6rem; background: rgba(235, 77, 75, 0.1); color: #eb4d4b; border-radius: 12px; font-weight: 500; min-width: 70px; text-align: center;">
                ร้าย {{ $negSum }}
            </div>
        </div>

        <!-- Right: Total Score -->
        <div style="text-align: left;">
            <div style="font-family: 'Kanit', sans-serif; color: #888; font-size: 0.8rem;">คะแนนรวม</div>
            <div style="font-family: 'Kanit', sans-serif; font-size: 2.5rem; line-height: 1; font-weight: bold; 
                        background: {{if lt .grand_total_score 0}}linear-gradient(135deg, #ff6b6b, #ee5253){{else}}linear-gradient(135deg, #20bf6b, #26de81){{end}}; 
                        -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                {{if gt .grand_total_score 0}}+{{end}}{{.grand_total_score}}
            </div>
        </div>

    </div>

    <!-- Action Buttons Grid (Compact Row) -->
    <div style="display: flex; gap: 0.5rem;">
        <!-- Numerology Button -->
        <button type="button" onclick="document.getElementById('meaning-modal-{{.cleaned_name}}').style.display='flex'"
            style="flex: 1; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 10px; padding: 0.6rem 0.3rem; cursor: pointer; transition: all 0.2s; display: flex; justify-content: center; align-items: center; gap: 0.4rem; color: #555;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="#2196f3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
                <path d="M12 11h4" />
                <path d="M12 16h4" />
                <path d="M8 11h.01" />
                <path d="M8 16h.01" />
            </svg>
            <span style="font-family: 'Kanit', sans-serif; font-size: 0.85rem;">เลขศาสตร์</span>
        </button>

        <!-- Linguistic Button -->
        <button type="button" hx-get="/linguistic-analysis?name={{.cleaned_name}}" hx-target="#linguistic-modal-content"
            hx-swap="innerHTML" hx-indicator="#linguistic-loader"
            onclick="document.getElementById('linguistic-modal-container').style.display='flex'"
            style="flex: 1; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 10px; padding: 0.6rem 0.3rem; cursor: pointer; transition: all 0.2s; display: flex; justify-content: center; align-items: center; gap: 0.4rem; color: #555;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="#4caf50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
            </svg>
            <span style="font-family: 'Kanit', sans-serif; font-size: 0.85rem;">ภาษาศาสตร์</span>
        </button>

        <!-- Save Button -->
        <button type="button" hx-post="/saved-names"
            hx-vals='{"name": "{{.cleaned_name}}", "birth_day": "{{.input_day_raw}}", "total_score": "{{.grand_total_score}}", "sat_sum": "{{.total_numerology_value}}", "sha_sum": "{{.total_shadow_value}}"}'
            hx-swap="none"
            style="flex: 1; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 10px; padding: 0.6rem 0.3rem; cursor: pointer; transition: all 0.2s; display: flex; justify-content: center; align-items: center; gap: 0.4rem; color: #555;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="#ff9800" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                <polyline points="17 21 17 13 7 13 7 21" />
                <polyline points="7 3 7 8 15 8" />
            </svg>
            <span style="font-family: 'Kanit', sans-serif; font-size: 0.85rem;">บันทึก</span>
        </button>
    </div>
</div>

<!-- Modal Placeholders -->
<div id="meaning-modal-{{.cleaned_name}}" class="modal-overlay" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
                    <path d="M12 11h4" />
                    <path d="M12 16h4" />
                    <path d="M8 11h.01" />
                    <path d="M8 16h.01" />
                </svg>
                เลขศาสตร์ของ "{{.cleaned_name}}"
            </h2>
            <button class="close-btn"
                onclick="document.getElementById('meaning-modal-{{.cleaned_name}}').style.display='none'">&times;</button>
        </div>
        <div class="modal-body">
            <h3>รายละเอียดตัวอักษร</h3>
            <table class="similar-names-table">
                <thead>
                    <tr>
                        <th>ตัวอักษร</th>
                        <th>เลขศาสตร์</th>
                        <th>พลังเงา</th>
                    </tr>
                </thead>
                <tbody>
                    {{$allowKlakini := .allow_klakini}}
                    {{range .decoded_parts}}
                    <tr>
                        <td>
                            {{if and .IsKlakini (not $allowKlakini)}}
                            <span class="klakini-char">{{.Character}}</span>
                            {{else}}
                            {{.Character}}
                            {{end}}
                        </td>
                        <td>{{.NumerologyValue}}</td>
                        <td>{{.ShadowValue}}</td>
                    </tr>
                    {{end}}
                </tbody>
            </table>

            <h3 style="margin-top: 1.5rem;">ความหมายคู่เลข</h3>
            {{range .all_unique_pairs}}
            <div class="meaning-item">
                <div class="meaning-header">
                    <span class="pair-number-badge" style="background-color: {{.Meaning.Color}};">{{.PairNumber}}</span>
                    <span class="pair-desc">{{.Meaning.MiracleDesc}}</span>
                </div>
                <div class="meaning-content">
                    <p>{{.Meaning.MiracleDetail}}</p>
                </div>
            </div>
            {{else}}
            <p>ไม่พบข้อมูล</p>
            {{end}}
        </div>
    </div>
</div>

<div id="linguistic-modal-container" class="modal-overlay" onclick="this.style.display='none'">
    <div id="linguistic-modal-content" class="modal-content" onclick="event.stopPropagation()">
        <!-- Content will be loaded here by HTMX -->
        <div id="linguistic-loader" class="htmx-indicator"
            style="flex-direction: column; align-items: center; justify-content: center; height: 200px;">
            <svg class="spinner" width="40px" height="40px" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                <circle class="path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"
                    style="stroke: #667eea;"></circle>
            </svg>
            <p style="margin-top: 1rem; color: #666; font-family: 'Kanit', sans-serif;">กำลังค้นหาข้อมูลภาษาศาสตร์...
            </p>
        </div>
    </div>
</div>
{{end}}