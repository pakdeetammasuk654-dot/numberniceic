{{define "partials/solar_system"}}
<style>
    /* Reset to simple, working CSS */
    .sun {
        position: relative;
        display: flex;           /* Use Flexbox on the container */
        justify-content: center; /* Center horizontally */
        align-items: center;     /* Center vertically */
    }

    .sun-name {
        font-size: 1.2rem;
        text-align: center;
        z-index: 1;
        /* No absolute positioning, no width/height 100% */
        /* Let Flexbox handle the centering naturally */
    }

    .score-analysis-grid {
        margin-top: 0;
    }

    /* Flexbox container to force characters together */
    .char-container {
        display: flex;
        justify-content: center;
        align-items: center;
    }
</style>

<!-- Solar System Animation -->
<div class="solar-system-container solar-bubble">
    <div class="solar-system">
        <div class="{{if .is_sun_dead}}sun sun-dead{{else}}sun{{end}}">

            <!-- Only the name remains here. No spinners, no overlays. -->
            <div class="sun-name">
                <div class="char-container">
                    {{- range .SunDisplayNameHTML -}}
                        {{- if .IsBad -}}<span class="klakini-char">{{.Char}}</span>{{- else -}}<span>{{.Char}}</span>{{- end -}}
                    {{- end -}}
                </div>
            </div>

        </div>
        <div class="orbit orbit-inner"></div>
        <div class="orbit orbit-outer"></div>
        {{ $numCount := len .numerology_pairs }}
        {{ range $i, $pair := .numerology_pairs }}
            {{ $delay := mul $i (div 20.0 $numCount) }}
            <div class="planet-container orbit-inner" style="animation-delay: -{{ $delay }}s;">
                <div class="planet" style="background-color: {{.Meaning.Color}}; animation-delay: -{{ $delay }}s;" title="{{.Meaning.MiracleDesc}}">
                    {{.PairNumber}}
                </div>
            </div>
        {{ end }}
        {{ $shaCount := len .shadow_pairs }}
        {{ range $i, $pair := .shadow_pairs }}
            {{ $delay := mul $i (div 30.0 $shaCount) }}
            <div class="planet-container orbit-outer" style="animation-delay: -{{ $delay }}s;">
                <div class="planet" style="background-color: {{.Meaning.Color}}; animation-delay: -{{ $delay }}s;" title="{{.Meaning.MiracleDesc}}">
                    {{.PairNumber}}
                </div>
            </div>
        {{ end }}
    </div>
</div>

<!-- Single, Consolidated Result Card -->
<div class="result-box" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
    <!-- New Score Summary -->
    <div class="score-summary-line">
        <strong>(คะแนน)</strong>
        <span class="score-good">ดี: +{{ add .num_positive_score .sha_positive_score }}</span>
        <span class="score-bad">ร้าย: {{ add .num_negative_score .sha_negative_score }}</span>
        <span>=</span>
        <strong class="{{if lt .grand_total_score 0}}score-bad{{else}}score-good{{end}}">
            {{if gt .grand_total_score 0}}+{{end}}{{.grand_total_score}}
        </strong>
    </div>

    <div class="action-links-container">
        <button type="button" class="link-button" onclick="document.getElementById('meaning-modal-{{.cleaned_name}}').style.display='flex'">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>
            เลขศาสตร์
        </button>
        <button type="button" class="link-button"
                hx-get="/linguistic-analysis?name={{.cleaned_name}}"
                hx-target="#linguistic-modal-content"
                hx-swap="innerHTML"
                hx-indicator="#linguistic-loading-{{.cleaned_name}}"
                onclick="document.getElementById('linguistic-modal-container-{{.cleaned_name}}').style.display='flex'">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
            ภาษาศาสตร์
        </button>
    </div>
</div>

<!-- Modal for Numerology Meanings -->
<div id="meaning-modal-{{.cleaned_name}}" class="modal-overlay" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2>คู่เลขของ "{{.cleaned_name}}"</h2>
            <button class="close-btn" onclick="document.getElementById('meaning-modal-{{.cleaned_name}}').style.display='none'">&times;</button>
        </div>
        <div class="modal-body">
            <h3>รายละเอียดตัวอักษร</h3>
            <table class="similar-names-table">
                <thead>
                    <tr>
                        <th>ตัวอักษร</th>
                        <th>เลขศาสตร์</th>
                        <th>พลังเงา</th>
                    </tr>
                </thead>
                <tbody>
                    {{$allowKlakini := .allow_klakini}}
                    {{range .decoded_parts}}
                    <tr>
                        <td>
                            {{if and .IsKlakini (not $allowKlakini)}}
                                <span class="klakini-char">{{.Character}}</span>
                            {{else}}
                                {{.Character}}
                            {{end}}
                        </td>
                        <td>{{.NumerologyValue}}</td>
                        <td>{{.ShadowValue}}</td>
                    </tr>
                    {{end}}
                </tbody>
            </table>

            <h3 style="margin-top: 1.5rem;">ความหมายคู่เลข</h3>
            {{range .all_unique_pairs}}
            <div class="meaning-item">
                <div class="meaning-header">
                    <span class="pair-number-badge" style="background-color: {{.Meaning.Color}};">{{.PairNumber}}</span>
                    <span class="pair-desc">{{.Meaning.MiracleDesc}}</span>
                </div>
                <div class="meaning-content">
                    <p>{{.Meaning.MiracleDetail}}</p>
                </div>
            </div>
            {{else}}
            <p>ไม่พบข้อมูล</p>
            {{end}}
        </div>
    </div>
</div>

<!-- Modal for Linguistic Analysis -->
<div id="linguistic-modal-container-{{.cleaned_name}}" class="modal-overlay" onclick="this.style.display='none'">
    <div id="linguistic-modal-content" class="modal-content" onclick="event.stopPropagation()">
        <!-- Content will be loaded here by HTMX -->
        <div id="linguistic-loading-{{.cleaned_name}}" class="htmx-indicator" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px;">
            <svg class="spinner" width="40px" height="40px" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
               <circle class="path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle>
            </svg>
            <p style="margin-top: 1rem; color: #666;">โปรดรอสักครู่ กำลังค้นหารากศัพท์....</p>
            <div style="margin-top: 0.5rem; font-size: 1.2rem; font-weight: bold; display: flex; align-items: center; gap: 0.5rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <span>'{{.cleaned_name}}'</span>
            </div>
        </div>
    </div>
</div>
{{end}}
