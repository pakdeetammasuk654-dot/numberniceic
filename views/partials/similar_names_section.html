{{define "partials/similar_names_section"}}
<style>
    .name-top-tier {
        color: #F57F17; /* Darker Gold/Sun color (Material Yellow 900) */
        font-weight: bold;
    }
    .name-not-top-tier {
        color: #757575; /* Grey */
        font-weight: normal;
    }
    .klakini-char {
        color: #C62828 !important; /* Dark Red, use !important to ensure it overrides */
    }
    .char-container {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .toggle-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-left: 1rem;
    }
    .toggle-label {
        font-size: 0.7rem;
        font-weight: normal;
        margin-top: 0.2rem;
        color: #666;
    }
    .similar-names-table th {
        font-size: 0.8rem; /* Reduced font size for table headers */
    }

    /* Simple Text Loader */
    #similar-names-loader {
        display: none;
        position: absolute;
        top: 15px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #333;
        color: #fff;
        padding: 8px 20px;
        border-radius: 20px;
        z-index: 10000;
        font-size: 1rem;
        font-weight: bold;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        white-space: nowrap;
    }
    /* Show loader when parent has htmx-request class */
    .htmx-request #similar-names-loader {
        display: block;
    }

    /* Fade out content when loading */
    .htmx-request.similar-names-container .speech-bubble-header,
    .htmx-request.similar-names-container .similar-names-table {
        opacity: 0.5;
        pointer-events: none; /* Prevent clicks while loading */
        transition: opacity 0.2s ease-in-out;
    }

    /* Revert score colors to original state */
    .score-good {
        color: #2E7D32;
        font-weight: bold;
    }

    .score-bad {
        color: #C62828;
        font-weight: bold;
    }
</style>
<div class="similar-names-container" id="similar-names-section" style="position: relative; min-height: 200px;">
    <!-- Simple Loader -->
    <div id="similar-names-loader">กำลังโหลด....</div>

    <div class="speech-bubble-header {{if .AnimateHeader}}bounce-in-animation{{end}}">
        <div class="header-text-content">
            <div class="header-main-line">
                <span class="header-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                </span>
                <span>ชื่อคล้าย "{{- range .DisplayNameHTML -}}{{.Char}}{{- end -}}"</span>
            </div>
            <div class="header-sub-line">
                <span style="font-size: 0.8rem; font-weight: normal; color: #666;">({{.input_day}})</span>
                {{if .klakini_characters}}
                <span style="font-size: 0.8rem; font-weight: normal; color: #C62828; margin-left: 0.5rem;">
                    (กาลกิณี: {{range .klakini_characters}}{{.}} {{end}})
                </span>
                {{else}}
                <span style="margin-left: 0.5rem; display: inline-flex; align-items: center; font-size: 0.8rem; color: #2E7D32;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#2E7D32" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.2rem;"><polyline points="20 6 9 17 4 12"/></svg>
                    ไร้กาลกิณี
                </span>
                {{end}}
            </div>
        </div>

        <div class="toggle-switch-container"
             hx-get="/similar-names"
             hx-target="#similar-names-section"
             hx-swap="outerHTML"
             hx-trigger="change"
             hx-indicator="#similar-names-section"
             hx-vals='js:{"name": (document.getElementById("name") ? document.getElementById("name").value : ""), "day": (document.getElementById("day") ? document.getElementById("day").value : ""), "auspicious": document.getElementById("auspicious-toggle").checked, "allow_klakini": document.getElementById("allow-klakini-toggle").checked}'>

            <!-- Auspicious Toggle -->
            <div class="toggle-item">
                <label class="toggle-switch">
                    <input type="checkbox" id="auspicious-toggle" name="auspicious" {{if .is_auspicious}}checked{{end}}
                           onchange="document.getElementById('main-auspicious').value = this.checked">
                    <span class="slider"></span>
                </label>
                <span class="toggle-label">ชื่อดีเท่านั้น</span>
            </div>

            <!-- Allow Klakini Toggle -->
            <div class="toggle-item">
                <label class="toggle-switch">
                    <input type="checkbox" id="allow-klakini-toggle" name="allow_klakini" {{if .allow_klakini}}checked{{end}}
                           onchange="document.getElementById('main-allow-klakini').value = this.checked">
                    <span class="slider"></span>
                </label>
                <span class="toggle-label">อนุโลมกาลกิณี</span>
            </div>
        </div>
    </div>

    <table class="similar-names-table">
        <thead>
            <tr>
                <th>ชื่อ/สกุล</th>
                <th>ไร้กาลกิณี</th>
                <th>เลขศาสตร์</th>
                <th>พลังเงา</th>
                <th>คะแนน</th>
                <th>คล้าย</th>
                <th></th> <!-- Action Column -->
            </tr>
        </thead>
        <tbody>
            {{$allowKlakini := .allow_klakini}}
            {{range $i, $name := .similar_names}}
            <tr class="{{if eq (mod $i 2) 0}}row-even{{else}}row-odd{{end}} clickable-row" onclick="selectName('{{$name.ThName}}')">
                <td>
                    <span class="{{if .IsTopTier}}name-top-tier{{else}}name-not-top-tier{{end}}">
                        {{- range .DisplayNameHTML -}}{{.Char}}{{- end -}}
                    </span>
                </td>
                <td>
                    {{if .KlakiniChars}}
                        <span class="klakini-char">{{range .KlakiniChars}}{{.}} {{end}}</span>
                    {{else}}
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2E7D32" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                    {{end}}
                </td>
                <td>
                    <div class="table-pairs-container">
                        {{range $j, $pairInfo := $name.TSat}}
                            {{$pairNumber := index $name.SatNum $j}}
                            <span class="table-pair-circle" style="background-color: {{$pairInfo.Color}};">{{$pairNumber}}</span>
                        {{end}}
                    </div>
                </td>
                <td>
                    <div class="table-pairs-container">
                        {{range $j, $pairInfo := $name.TSha}}
                            {{$pairNumber := index $name.ShaNum $j}}
                            <span class="table-pair-circle" style="background-color: {{$pairInfo.Color}};">{{$pairNumber}}</span>
                        {{end}}
                    </div>
                </td>
                <td>
                    <span class="{{if lt $name.TotalScore 0}}score-bad{{else}}score-good{{end}}">
                        {{if gt $name.TotalScore 0}}+{{end}}{{$name.TotalScore}}
                    </span>
                </td>
                <td>
                    <span style="font-size: 0.9rem;">{{printf "%.2f" $name.Similarity}}</span>
                </td>
                <td style="text-align: center;">
                    <span class="action-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    </span>
                </td>
            </tr>
            {{else}}
            <tr>
                <td colspan="7" style="text-align: center;">ไม่พบชื่อที่ใกล้เคียง</td>
            </tr>
            {{end}}
        </tbody>
    </table>
</div>
<script>
    // Immediate execution to sync state when this partial is swapped in
    (function() {
        const mainAuspicious = document.getElementById('main-auspicious');
        const auspiciousToggle = document.getElementById('auspicious-toggle');
        if (mainAuspicious && auspiciousToggle) {
            mainAuspicious.value = auspiciousToggle.checked;
        }

        const mainAllowKlakini = document.getElementById('main-allow-klakini');
        const allowKlakiniToggle = document.getElementById('allow-klakini-toggle');
        if (mainAllowKlakini && allowKlakiniToggle) {
            mainAllowKlakini.value = allowKlakiniToggle.checked;
        }
    })();
</script>
{{end}}